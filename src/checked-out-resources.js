"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const nodeFetch = require('node-fetch');
const tough = require('tough-cookie');
const node_html_parser_1 = require("node-html-parser");
const llcoopUrl = (pathAndQuery) => "https://sam.llcoop.org" + pathAndQuery;
const getCheckedOutItems = async (cred) => {
    const url = llcoopUrl("/patroninfo");
    const fetch = require('fetch-cookie/node-fetch')(nodeFetch, new tough.CookieJar());
    const response = await fetch(url, { method: "POST", body: `code=${cred.barcode}&pin=${cred.pin}`, headers: { "Content-Type": "application/x-www-form-urlencoded" } });
    const text = await response.text();
    const match = /\/patroninfo\~S\d+\/\d+\/items/ig.exec(text);
    if (match) {
        const itemsUrl = llcoopUrl(match[0]);
        const itemsResponse = await fetch(itemsUrl);
        const root = node_html_parser_1.parse(await itemsResponse.text());
        var result = root.querySelectorAll("tr.patFuncEntry").map((row) => {
            const get = (clazz) => {
                const selector = row.querySelector(clazz);
                return selector ? selector.structuredText : null;
            };
            const getAtt = (clazz, att) => {
                const selector = row.querySelector(clazz);
                return selector && selector.attributes ? selector.attributes[att] : null;
            };
            const renewed = get(".patFuncRenewCount");
            const { title, acknowledgements } = splitTitleAndAcknowledgements(get(".patFuncTitleMain"));
            const status = get(".patFuncStatus").replace(renewed, "").replace(/(\d\d-\d\d)-(\d\d)/, "20$2-$1").trim();
            const dueMatch = /DUE\s+(\d{4}-\d{2}-\d{2})/.exec(status);
            const due = dueMatch ? dueMatch[1] : null;
            return {
                who: cred.name,
                title,
                acknowledgements,
                image: generateImageUrls(getAtt(".patFuncTitle a", "href")),
                status,
                due,
                renewed,
            };
        });
        result.sort((a, b) => a.due < b.due ? -1 : (a.due === b.due ? 0 : 1));
        return result;
    }
    return [];
};
exports.handler = async (event = {}) => {
    if (!event.body) {
        return { statusCode: 400, body: 'invalid request, you are missing the parameter body' };
    }
    const args = JSON.parse(event.body);
    const response = { results: new Array(args.credentials.length) };
    try {
        await Promise.all(args.credentials.map(async (cred, i) => {
            const x = await getCheckedOutItems(cred);
            response.results[i] = x;
        }));
        const flat = response.results.reduce((a, b) => a.concat(b), []);
        return { statusCode: 200, body: JSON.stringify({ results: flat }) };
    }
    catch (err) {
        return { statusCode: 500, body: JSON.stringify(err) };
    }
};
function generateImageUrls(href) {
    if (href) {
        var matches = /\/record=([a-zA-Z0-9]+)~/.exec(href);
        if (matches) {
            return {
                thumb: llcoopUrl(`/bookjacket?recid=${matches[1]}&size=0`),
                normal: llcoopUrl(`/bookjacket?recid=${matches[1]}&size=1`),
            };
        }
    }
    return null;
}
function splitTitleAndAcknowledgements(s) {
    const slash = s.indexOf(" / ");
    if (slash >= 0) {
        return {
            title: s.substring(0, slash),
            acknowledgements: s.substring(slash + 3).split(" ; ")
        };
    }
    return { title: s };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tlZC1vdXQtcmVzb3VyY2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hlY2tlZC1vdXQtcmVzb3VyY2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3hDLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUN0Qyx1REFBeUM7QUFFekMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxZQUFvQixFQUFFLEVBQUUsQ0FBQyx3QkFBd0IsR0FBRyxZQUFZLENBQUM7QUFFcEYsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLEVBQUUsSUFBdUIsRUFBRSxFQUFFO0lBQzNELE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNyQyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUNuRixNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxHQUFHLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLElBQUksQ0FBQyxPQUFPLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFDLGNBQWMsRUFBQyxtQ0FBbUMsRUFBQyxFQUFFLENBQUMsQ0FBQztJQUNuSyxNQUFNLElBQUksR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQyxNQUFNLEtBQUssR0FBRyxrQ0FBa0MsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUQsSUFBSSxLQUFLLEVBQUU7UUFDVCxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFckMsTUFBTSxhQUFhLEdBQUcsTUFBTSxLQUFLLENBQUMsUUFB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SUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELFNBQVMsNkJBQTZCLENBQUMsQ0FBVTtJQUMvQyxNQUFNLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9CLElBQUksS0FBSyxJQUFJLENBQUMsRUFBRTtRQUNkLE9BQU87WUFDTCxLQUFLLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDO1lBQzVCLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7U0FDdEQsQ0FBQztLQUNIO0lBQ0QsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQztBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgbm9kZUZldGNoID0gcmVxdWlyZSgnbm9kZS1mZXRjaCcpO1xyXG5jb25zdCB0b3VnaCA9IHJlcXVpcmUoJ3RvdWdoLWNvb2tpZScpO1xyXG5pbXBvcnQgeyBwYXJzZSB9IGZyb20gJ25vZGUtaHRtbC1wYXJzZXInO1xyXG5cclxuY29uc3QgbGxjb29wVXJsID0gKHBhdGhBbmRRdWVyeTogc3RyaW5nKSA9PiBcImh0dHBzOi8vc2FtLmxsY29vcC5vcmdcIiArIHBhdGhBbmRRdWVyeTtcclxuXHJcbmNvbnN0IGdldENoZWNrZWRPdXRJdGVtcyA9IGFzeW5jIChjcmVkOiBMTENvb3BDcmVkZW50aWFscykgPT4ge1xyXG4gIGNvbnN0IHVybCA9IGxsY29vcFVybChcIi9wYXRyb25pbmZvXCIpO1xyXG4gIGNvbnN0IGZldGNoID0gcmVxdWlyZSgnZmV0Y2gtY29va2llL25vZGUtZmV0Y2gnKShub2RlRmV0Y2gsIG5ldyB0b3VnaC5Db29raWVKYXIoKSk7XHJcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsgbWV0aG9kOiBcIlBPU1RcIiwgYm9keTogYGNvZGU9JHtjcmVkLmJhcmNvZGV9JnBpbj0ke2NyZWQucGlufWAsIGhlYWRlcnM6IHtcIkNvbnRlbnQtVHlwZVwiOlwiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXCJ9IH0pO1xyXG4gIGNvbnN0IHRleHQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XHJcbiAgY29uc3QgbWF0Y2ggPSAvXFwvcGF0cm9uaW5mb1xcflNcXGQrXFwvXFxkK1xcL2l0ZW1zL2lnLmV4ZWModGV4dCk7XHJcbiAgaWYgKG1hdGNoKSB7XHJcbiAgICBjb25zdCBpdGVtc1VybCA9IGxsY29vcFVybChtYXRjaFswXSk7XHJcblxyXG4gICAgY29uc3QgaXRlbXNSZXNwb25zZSA9IGF3YWl0IGZldGNoKGl0ZW1zVXJsKTtcclxuICAgIGNvbnN0IHJvb3QgPSBwYXJzZShhd2FpdCBpdGVtc1Jlc3BvbnNlLnRleHQoKSk7XHJcblxyXG4gICAgdmFyIHJlc3VsdCA6IFtdID0gKHJvb3QgYXMgYW55KS5xdWVyeVNlbGVjdG9yQWxsKFwidHIucGF0RnVuY0VudHJ5XCIpLm1hcCgocm93OmFueSkgPT4ge1xyXG4gICAgICBjb25zdCBnZXQgPSAoY2xheno6c3RyaW5nKSA6IHN0cmluZyA9PiB7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSByb3cucXVlcnlTZWxlY3RvcihjbGF6eik7XHJcbiAgICAgICAgcmV0dXJuIHNlbGVjdG9yID8gc2VsZWN0b3Iuc3RydWN0dXJlZFRleHQgOiBudWxsO1xyXG4gICAgICB9O1xyXG4gICAgICBjb25zdCBnZXRBdHQgPSAoY2xheno6c3RyaW5nLCBhdHQ6c3RyaW5nKSA6IHN0cmluZyA9PiB7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSByb3cucXVlcnlTZWxlY3RvcihjbGF6eik7XHJcbiAgICAgICAgcmV0dXJuIHNlbGVjdG9yICYmIHNlbGVjdG9yLmF0dHJpYnV0ZXMgPyBzZWxlY3Rvci5hdHRyaWJ1dGVzW2F0dF0gOiBudWxsO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgcmVuZXdlZCA9IGdldChcIi5wYXRGdW5jUmVuZXdDb3VudFwiKTtcclxuXHJcbiAgICAgIGNvbnN0IHsgdGl0bGUsIGFja25vd2xlZGdlbWVudHMgfSA9IHNwbGl0VGl0bGVBbmRBY2tub3dsZWRnZW1lbnRzKGdldChcIi5wYXRGdW5jVGl0bGVNYWluXCIpKTtcclxuXHJcbiAgICAgIGNvbnN0IHN0YXR1cyA9IGdldChcIi5wYXRGdW5jU3RhdHVzXCIpLnJlcGxhY2UocmVuZXdlZCwgXCJcIikucmVwbGFjZSgvKFxcZFxcZC1cXGRcXGQpLShcXGRcXGQpLywgXCIyMCQyLSQxXCIpLnRyaW0oKTtcclxuICAgICAgY29uc3QgZHVlTWF0Y2ggPSAvRFVFXFxzKyhcXGR7NH0tXFxkezJ9LVxcZHsyfSkvLmV4ZWMoc3RhdHVzKTtcclxuICAgICAgY29uc3QgZHVlID0gZHVlTWF0Y2ggPyBkdWVNYXRjaFsxXSA6IG51bGw7XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHdobzogY3JlZC5uYW1lLFxyXG4gICAgICAgIHRpdGxlLFxyXG4gICAgICAgIGFja25vd2xlZGdlbWVudHMsXHJcbiAgICAgICAgaW1hZ2U6IGdlbmVyYXRlSW1hZ2VVcmxzKGdldEF0dChcIi5wYXRGdW5jVGl0bGUgYVwiLCBcImhyZWZcIikpLFxyXG4gICAgICAgIHN0YXR1cyxcclxuICAgICAgICBkdWUsXHJcbiAgICAgICAgcmVuZXdlZCxcclxuICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJlc3VsdC5zb3J0KChhOmFueSwgYjphbnkpID0+IGEuZHVlIDwgYi5kdWUgPyAtMSA6IChhLmR1ZSA9PT0gYi5kdWUgPyAwIDogMSkpO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHJldHVybiBbXTtcclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnkgPSB7fSkgOiBQcm9taXNlIDxhbnk+ID0+IHtcclxuICBpZiAoIWV2ZW50LmJvZHkpIHtcclxuICAgIHJldHVybiB7IHN0YXR1c0NvZGU6IDQwMCwgYm9keTogJ2ludmFsaWQgcmVxdWVzdCwgeW91IGFyZSBtaXNzaW5nIHRoZSBwYXJhbWV0ZXIgYm9keScgfTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGFyZ3MgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xyXG4gIGNvbnN0IHJlc3BvbnNlID0geyByZXN1bHRzOiBuZXcgQXJyYXkoYXJncy5jcmVkZW50aWFscy5sZW5ndGgpIH07XHJcblxyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgYXJncy5jcmVkZW50aWFscy5tYXAoYXN5bmMgKGNyZWQ6IExMQ29vcENyZWRlbnRpYWxzLCBpOiBudW1iZXIpID0+IHtcclxuICAgICAgICBjb25zdCB4ID0gYXdhaXQgZ2V0Q2hlY2tlZE91dEl0ZW1zKGNyZWQpO1xyXG4gICAgICAgIHJlc3BvbnNlLnJlc3VsdHNbaV0gPSB4O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBmbGF0ID0gcmVzcG9uc2UucmVzdWx0cy5yZWR1Y2UoKGEsYikgPT4gYS5jb25jYXQoYiksIFtdKTtcclxuXHJcbiAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtyZXN1bHRzOmZsYXR9KSB9O1xyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogNTAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShlcnIpfTtcclxuICB9XHJcbn07XHJcblxyXG5pbnRlcmZhY2UgTExDb29wQ3JlZGVudGlhbHMge1xyXG4gIG5hbWU6IHN0cmluZztcclxuICBiYXJjb2RlOiBzdHJpbmc7XHJcbiAgcGluOiBzdHJpbmc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlSW1hZ2VVcmxzKGhyZWYgOiBzdHJpbmcpIHtcclxuICBpZiAoaHJlZikge1xyXG4gICAgdmFyIG1hdGNoZXMgPSAvXFwvcmVjb3JkPShbYS16QS1aMC05XSspfi8uZXhlYyhocmVmKTtcclxuICAgIGlmIChtYXRjaGVzKSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgdGh1bWI6IGxsY29vcFVybChgL2Jvb2tqYWNrZXQ/cmVjaWQ9JHttYXRjaGVzWzFdfSZzaXplPTBgKSxcclxuICAgICAgICBub3JtYWw6IGxsY29vcFVybChgL2Jvb2tqYWNrZXQ/cmVjaWQ9JHttYXRjaGVzWzFdfSZzaXplPTFgKSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNwbGl0VGl0bGVBbmRBY2tub3dsZWRnZW1lbnRzKHMgOiBzdHJpbmcpIHtcclxuICBjb25zdCBzbGFzaCA9IHMuaW5kZXhPZihcIiAvIFwiKTtcclxuICBpZiAoc2xhc2ggPj0gMCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdGl0bGU6IHMuc3Vic3RyaW5nKDAsIHNsYXNoKSxcclxuICAgICAgYWNrbm93bGVkZ2VtZW50czogcy5zdWJzdHJpbmcoc2xhc2ggKyAzKS5zcGxpdChcIiA7IFwiKVxyXG4gICAgfTtcclxuICB9XHJcbiAgcmV0dXJuIHsgdGl0bGU6IHMgfTtcclxufSJdfQ==