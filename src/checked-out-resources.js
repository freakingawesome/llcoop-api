"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const nodeFetch = require('node-fetch');
const tough = require('tough-cookie');
const node_html_parser_1 = require("node-html-parser");
// import * as moment from 'moment';
const moment = require("moment-timezone");
const getCheckedOutItems = async (cred) => {
    const llcoopUrl = (pathAndQuery) => cred.rootUrl + pathAndQuery;
    const url = llcoopUrl("/patroninfo");
    const fetch = require('fetch-cookie/node-fetch')(nodeFetch, new tough.CookieJar());
    const response = await fetch(url, { method: "POST", body: `code=${cred.barcode}&pin=${cred.pin}`, headers: { "Content-Type": "application/x-www-form-urlencoded" } });
    const text = await response.text();
    const match = /\/patroninfo\~S\d+\/\d+\/items/ig.exec(text);
    if (match) {
        const itemsUrl = llcoopUrl(match[0]);
        const itemsResponse = await fetch(itemsUrl);
        const root = node_html_parser_1.parse(await itemsResponse.text());
        var result = root.querySelectorAll("tr.patFuncEntry").map((row) => {
            const get = (clazz) => {
                const selector = row.querySelector(clazz);
                return selector ? selector.structuredText : null;
            };
            const getAtt = (clazz, att) => {
                const selector = row.querySelector(clazz);
                return selector && selector.attributes ? selector.attributes[att] : null;
            };
            const renewed = get(".patFuncRenewCount");
            const { title, acknowledgements } = splitTitleAndAcknowledgements(get(".patFuncTitleMain"));
            const status = get(".patFuncStatus").replace(renewed, "").replace(/(\d\d-\d\d)-(\d\d)/, "20$2-$1").trim();
            const dueMatch = /DUE\s+(\d{4}-\d{2}-\d{2})/.exec(status);
            const due = dueMatch ? dueMatch[1] : null;
            const dueInDays = due ? moment.tz(`${due}T23:59:59`, cred.tz).diff(moment(), "days") : null;
            return {
                who: cred.name,
                title,
                acknowledgements,
                image: generateImageUrls(getAtt(".patFuncTitle a", "href"), llcoopUrl),
                status,
                due,
                dueInDays,
                renewed,
            };
        });
        result.sort((a, b) => a.due < b.due ? -1 : (a.due === b.due ? 0 : 1));
        return result;
    }
    return [];
};
exports.handler = async (event = {}) => {
    if (!event.body) {
        return { statusCode: 400, body: 'invalid request, you are missing the parameter body' };
    }
    const args = JSON.parse(event.body);
    const response = { results: new Array(args.credentials.length) };
    try {
        await Promise.all(args.credentials.map(async (cred, i) => {
            const x = await getCheckedOutItems(cred);
            response.results[i] = x;
        }));
        const flat = response.results.reduce((a, b) => a.concat(b), []);
        return { statusCode: 200, body: JSON.stringify({ results: flat }) };
    }
    catch (err) {
        return { statusCode: 500, body: JSON.stringify(err) };
    }
};
function generateImageUrls(href, llcoopUrl) {
    if (href) {
        var matches = /\/record=([a-zA-Z0-9]+)~/.exec(href);
        if (matches) {
            return {
                thumb: llcoopUrl(`/bookjacket?recid=${matches[1]}&size=0`),
                normal: llcoopUrl(`/bookjacket?recid=${matches[1]}&size=1`),
            };
        }
    }
    return null;
}
function splitTitleAndAcknowledgements(s) {
    const slash = s.indexOf(" / ");
    if (slash >= 0) {
        return {
            title: s.substring(0, slash),
            acknowledgements: s.substring(slash + 3).split(" ; ")
        };
    }
    return { title: s };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tlZC1vdXQtcmVzb3VyY2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hlY2tlZC1vdXQtcmVzb3VyY2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3hDLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUN0Qyx1REFBeUM7QUFDekMsb0NBQW9DO0FBQ3BDLDBDQUEwQztBQUUxQyxNQUFNLGtCQUFrQixHQUFHLEtBQUssRUFBRSxJQUF1QixFQUFFLEVBQUU7SUFDM0QsTUFBTSxTQUFTLEdBQUcsQ0FBQyxZQUFvQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQztJQUN4RSxNQUFNLEdBQUcsR0FBRyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDckMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUMsU0FBUyxFQUFFLElBQUksS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDbkYsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxJQUFJLENBQUMsT0FBTyxRQUFRLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBQyxjQUFjLEVBQUMsbUNBQW1DLEVBQUMsRUFBRSxDQUFDLENBQUM7SUFDbkssTUFBTSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbkMsTUFBTSxLQUFLLEdBQUcsa0NBQWtDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVELElBQUksS0FBSyxFQUFFO1FBQ1QsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXJD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LEdBQUcsMEJBQTBCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELElBQUksT0FBTyxFQUFFO1lBQ1gsT0FBTztnQkFDTCxLQUFLLEVBQUUsU0FBUyxDQUFDLHFCQUFxQixPQUFPLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztnQkFDMUQsTUFBTSxFQUFFLFNBQVMsQ0FBQyxxQkFBcUIsT0FBTyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7YUFDNUQsQ0FBQztTQUNIO0tBQ0Y7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLDZCQUE2QixDQUFDLENBQVU7SUFDL0MsTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQixJQUFJLEtBQUssSUFBSSxDQUFDLEVBQUU7UUFDZCxPQUFPO1lBQ0wsS0FBSyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQztZQUM1QixnQkFBZ0IsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO1NBQ3RELENBQUM7S0FDSDtJQUNELE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG5vZGVGZXRjaCA9IHJlcXVpcmUoJ25vZGUtZmV0Y2gnKTtcclxuY29uc3QgdG91Z2ggPSByZXF1aXJlKCd0b3VnaC1jb29raWUnKTtcclxuaW1wb3J0IHsgcGFyc2UgfSBmcm9tICdub2RlLWh0bWwtcGFyc2VyJztcclxuLy8gaW1wb3J0ICogYXMgbW9tZW50IGZyb20gJ21vbWVudCc7XHJcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnO1xyXG5cclxuY29uc3QgZ2V0Q2hlY2tlZE91dEl0ZW1zID0gYXN5bmMgKGNyZWQ6IExMQ29vcENyZWRlbnRpYWxzKSA9PiB7XHJcbiAgY29uc3QgbGxjb29wVXJsID0gKHBhdGhBbmRRdWVyeTogc3RyaW5nKSA9PiBjcmVkLnJvb3RVcmwgKyBwYXRoQW5kUXVlcnk7XHJcbiAgY29uc3QgdXJsID0gbGxjb29wVXJsKFwiL3BhdHJvbmluZm9cIik7XHJcbiAgY29uc3QgZmV0Y2ggPSByZXF1aXJlKCdmZXRjaC1jb29raWUvbm9kZS1mZXRjaCcpKG5vZGVGZXRjaCwgbmV3IHRvdWdoLkNvb2tpZUphcigpKTtcclxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwgeyBtZXRob2Q6IFwiUE9TVFwiLCBib2R5OiBgY29kZT0ke2NyZWQuYmFyY29kZX0mcGluPSR7Y3JlZC5waW59YCwgaGVhZGVyczoge1wiQ29udGVudC1UeXBlXCI6XCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRcIn0gfSk7XHJcbiAgY29uc3QgdGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcclxuICBjb25zdCBtYXRjaCA9IC9cXC9wYXRyb25pbmZvXFx+U1xcZCtcXC9cXGQrXFwvaXRlbXMvaWcuZXhlYyh0ZXh0KTtcclxuICBpZiAobWF0Y2gpIHtcclxuICAgIGNvbnN0IGl0ZW1zVXJsID0gbGxjb29wVXJsKG1hdGNoWzBdKTtcclxuXHJcbiAgICBjb25zdCBpdGVtc1Jlc3BvbnNlID0gYXdhaXQgZmV0Y2goaXRlbXNVcmwpO1xyXG4gICAgY29uc3Qgcm9vdCA9IHBhcnNlKGF3YWl0IGl0ZW1zUmVzcG9uc2UudGV4dCgpKTtcclxuXHJcbiAgICB2YXIgcmVzdWx0IDogW10gPSAocm9vdCBhcyBhbnkpLnF1ZXJ5U2VsZWN0b3JBbGwoXCJ0ci5wYXRGdW5jRW50cnlcIikubWFwKChyb3c6YW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IGdldCA9IChjbGF6ejpzdHJpbmcpIDogc3RyaW5nID0+IHtcclxuICAgICAgICBjb25zdCBzZWxlY3RvciA9IHJvdy5xdWVyeVNlbGVjdG9yKGNsYXp6KTtcclxuICAgICAgICByZXR1cm4gc2VsZWN0b3IgPyBzZWxlY3Rvci5zdHJ1Y3R1cmVkVGV4dCA6IG51bGw7XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IGdldEF0dCA9IChjbGF6ejpzdHJpbmcsIGF0dDpzdHJpbmcpIDogc3RyaW5nID0+IHtcclxuICAgICAgICBjb25zdCBzZWxlY3RvciA9IHJvdy5xdWVyeVNlbGVjdG9yKGNsYXp6KTtcclxuICAgICAgICByZXR1cm4gc2VsZWN0b3IgJiYgc2VsZWN0b3IuYXR0cmlidXRlcyA/IHNlbGVjdG9yLmF0dHJpYnV0ZXNbYXR0XSA6IG51bGw7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCByZW5ld2VkID0gZ2V0KFwiLnBhdEZ1bmNSZW5ld0NvdW50XCIpO1xyXG5cclxuICAgICAgY29uc3QgeyB0aXRsZSwgYWNrbm93bGVkZ2VtZW50cyB9ID0gc3BsaXRUaXRsZUFuZEFja25vd2xlZGdlbWVudHMoZ2V0KFwiLnBhdEZ1bmNUaXRsZU1haW5cIikpO1xyXG5cclxuICAgICAgY29uc3Qgc3RhdHVzID0gZ2V0KFwiLnBhdEZ1bmNTdGF0dXNcIikucmVwbGFjZShyZW5ld2VkLCBcIlwiKS5yZXBsYWNlKC8oXFxkXFxkLVxcZFxcZCktKFxcZFxcZCkvLCBcIjIwJDItJDFcIikudHJpbSgpO1xyXG4gICAgICBjb25zdCBkdWVNYXRjaCA9IC9EVUVcXHMrKFxcZHs0fS1cXGR7Mn0tXFxkezJ9KS8uZXhlYyhzdGF0dXMpO1xyXG4gICAgICBjb25zdCBkdWUgPSBkdWVNYXRjaCA/IGR1ZU1hdGNoWzFdIDogbnVsbDtcclxuICAgICAgY29uc3QgZHVlSW5EYXlzID0gZHVlID8gbW9tZW50LnR6KGAke2R1ZX1UMjM6NTk6NTlgLCBjcmVkLnR6KS5kaWZmKG1vbWVudCgpLCBcImRheXNcIikgOiBudWxsO1xyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICB3aG86IGNyZWQubmFtZSxcclxuICAgICAgICB0aXRsZSxcclxuICAgICAgICBhY2tub3dsZWRnZW1lbnRzLFxyXG4gICAgICAgIGltYWdlOiBnZW5lcmF0ZUltYWdlVXJscyhnZXRBdHQoXCIucGF0RnVuY1RpdGxlIGFcIiwgXCJocmVmXCIpLCBsbGNvb3BVcmwpLFxyXG4gICAgICAgIHN0YXR1cyxcclxuICAgICAgICBkdWUsXHJcbiAgICAgICAgZHVlSW5EYXlzLFxyXG4gICAgICAgIHJlbmV3ZWQsXHJcbiAgICAgIH07XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXN1bHQuc29ydCgoYTphbnksIGI6YW55KSA9PiBhLmR1ZSA8IGIuZHVlID8gLTEgOiAoYS5kdWUgPT09IGIuZHVlID8gMCA6IDEpKTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICByZXR1cm4gW107XHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogYW55ID0ge30pIDogUHJvbWlzZSA8YW55PiA9PiB7XHJcbiAgaWYgKCFldmVudC5ib2R5KSB7XHJcbiAgICByZXR1cm4geyBzdGF0dXNDb2RlOiA0MDAsIGJvZHk6ICdpbnZhbGlkIHJlcXVlc3QsIHlvdSBhcmUgbWlzc2luZyB0aGUgcGFyYW1ldGVyIGJvZHknIH07XHJcbiAgfVxyXG5cclxuICBjb25zdCBhcmdzID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcclxuICBjb25zdCByZXNwb25zZSA9IHsgcmVzdWx0czogbmV3IEFycmF5KGFyZ3MuY3JlZGVudGlhbHMubGVuZ3RoKSB9O1xyXG5cclxuICB0cnkge1xyXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgIGFyZ3MuY3JlZGVudGlhbHMubWFwKGFzeW5jIChjcmVkOiBMTENvb3BDcmVkZW50aWFscywgaTogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgY29uc3QgeCA9IGF3YWl0IGdldENoZWNrZWRPdXRJdGVtcyhjcmVkKTtcclxuICAgICAgICByZXNwb25zZS5yZXN1bHRzW2ldID0geDtcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZmxhdCA9IHJlc3BvbnNlLnJlc3VsdHMucmVkdWNlKChhLGIpID0+IGEuY29uY2F0KGIpLCBbXSk7XHJcblxyXG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBib2R5OiBKU09OLnN0cmluZ2lmeSh7cmVzdWx0czpmbGF0fSkgfTtcclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIHJldHVybiB7IHN0YXR1c0NvZGU6IDUwMCwgYm9keTogSlNPTi5zdHJpbmdpZnkoZXJyKX07XHJcbiAgfVxyXG59O1xyXG5cclxuaW50ZXJmYWNlIExMQ29vcENyZWRlbnRpYWxzIHtcclxuICByb290VXJsOiBzdHJpbmc7IC8vIGUuZy4gXCJodHRwczovL3NhbS5sbGNvb3Aub3JnXCJcclxuICB0ejogc3RyaW5nOyAvLyBlLmcuIFVTL0Vhc3Rlcm5cclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgYmFyY29kZTogc3RyaW5nO1xyXG4gIHBpbjogc3RyaW5nO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5lcmF0ZUltYWdlVXJscyhocmVmIDogc3RyaW5nLCBsbGNvb3BVcmw6IChzdHJpbmcpID0+IHN0cmluZykge1xyXG4gIGlmIChocmVmKSB7XHJcbiAgICB2YXIgbWF0Y2hlcyA9IC9cXC9yZWNvcmQ9KFthLXpBLVowLTldKyl+Ly5leGVjKGhyZWYpO1xyXG4gICAgaWYgKG1hdGNoZXMpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICB0aHVtYjogbGxjb29wVXJsKGAvYm9va2phY2tldD9yZWNpZD0ke21hdGNoZXNbMV19JnNpemU9MGApLFxyXG4gICAgICAgIG5vcm1hbDogbGxjb29wVXJsKGAvYm9va2phY2tldD9yZWNpZD0ke21hdGNoZXNbMV19JnNpemU9MWApLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gbnVsbDtcclxufVxyXG5cclxuZnVuY3Rpb24gc3BsaXRUaXRsZUFuZEFja25vd2xlZGdlbWVudHMocyA6IHN0cmluZykge1xyXG4gIGNvbnN0IHNsYXNoID0gcy5pbmRleE9mKFwiIC8gXCIpO1xyXG4gIGlmIChzbGFzaCA+PSAwKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0aXRsZTogcy5zdWJzdHJpbmcoMCwgc2xhc2gpLFxyXG4gICAgICBhY2tub3dsZWRnZW1lbnRzOiBzLnN1YnN0cmluZyhzbGFzaCArIDMpLnNwbGl0KFwiIDsgXCIpXHJcbiAgICB9O1xyXG4gIH1cclxuICByZXR1cm4geyB0aXRsZTogcyB9O1xyXG59Il19